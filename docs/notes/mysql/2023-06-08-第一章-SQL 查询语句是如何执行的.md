# 第一章. SQL 查询语句是如何执行的

## 1. MySQL 逻辑架构图

![mysql_logic_architecture.webp](:/3329139dec73436abe1898e83e93f330)

* 语句：mysql> select * from T where ID=10；

## 2. Server 层：跨存储引擎，核心功能、内置函数、存储过程、触发器、视图

1.  连接器：用户权限验证、管理连接
    * mysql -h\$ip -P\$port -u\$user -p（回车后输密码），建立 TCP 握手后自动验证账号密码
    * 连接成功后查询权限一直存储，权限更新需要重连才生效
    * 连接不使用默认超时时间 8 小时，通过参数 wait_timeout
    * **长连接**：推荐，一直连接
    	* 内存增长快，容易 OOM 被异常重启
        * 版本大于等于 5.7，多次查询或大查询后，执行 mysql_reset_connection 重置连接资源（非重连与权限验证）
    * 短连接：不推荐，每隔几次查询就断开
2.  查询缓存：K - V 存储 SQL 语句与查询结果
    * **不推荐使用**，一般命中率低下，更新表后会该表缓存全失效
    * **版本大于等于 8.0 此业务被完全删除**
    * PS：返回时查询表的使用权限
3.  分析器：做什么
    * 词法分析：分析单词，查询语句、表 T、字段 ID ...
    * 语法分析：按照语法规则判断
4.  优化器：怎么做效率最高
    * 多个索引：选择索引
    * 联表：选择联表顺序
    * 执行计划确定下来，进入执行过程
    * PS：优化器之前调用 precheck 查询权限
5.  执行器：调用存储引擎，返回结果
    * 查询表的使用权限
    * 使用存储引擎接口
	* 执行流程
		1. 选择表的存储引擎，获取对应接口
		2. 通过接口 扫描每一行/有索引则调用满足条件的接口扫描每一行，符合全部条件的数据加入结果集
		3. 结果集数据返回客户端
	* explain 查询执行过程时，rows_examined 字段显示的是执行器扫描的总行数
		* 注意引擎扫描行数不一定等于执行器扫描行数，因为调用一起引擎、引起内部可能扫描多行  
* 存储引擎层（storage engine）：**InnoDB**、MyISAM、Memory 引擎插件式


## 3. 存储引擎层：存储数据，提供读写接口

* **版本大于等于 5.5.5 开始，InnoDB 为默认引擎**，以前是 MyISAM
